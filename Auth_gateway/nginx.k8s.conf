worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=3r/s;

    # Kubernetes service DNS resolution
    resolver kube-dns.kube-system.svc.cluster.local valid=5s;

    server {
        listen 8081;
        server_name localhost;

        # Auth routes (login, callback, logout) -> auth-service directly (no Lua)
        location ~ ^/api/auth/(login|callback|logout|post-logout) {
            # Hide any CORS headers from upstream
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Credentials';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';
            
            # Set our own CORS headers
            add_header 'Access-Control-Allow-Origin' 'http://localhost:4200' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cookie' always;
            
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            
            proxy_pass http://auth-service.dftp-mcp.svc.cluster.local:8280;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # /api/auth/me -> Goes through Lua first, then to auth-service
        location = /api/auth/me {
            # Hide any CORS headers from upstream
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Credentials';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';
            
            # Set our own CORS headers
            add_header 'Access-Control-Allow-Origin' 'http://localhost:4200' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cookie' always;
            
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            
            # Run Lua auth to extract JWT and set headers
            access_by_lua_file /lua/auth.lua;
            
            proxy_pass http://auth-service.dftp-mcp.svc.cluster.local:8280;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Other API routes -> backend
        location /api/ {
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Credentials';
            
            add_header 'Access-Control-Allow-Origin' 'http://localhost:4200' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cookie' always;
            
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            
            access_by_lua_file /lua/auth.lua;

            proxy_pass http://backend.dftp-mcp.svc.cluster.local:8060;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # For streaming responses (chat)
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_buffering off;
            proxy_read_timeout 300s;
        }
    }
}
